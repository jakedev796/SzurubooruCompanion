var background=(function(){"use strict";function q(r){return r&&r.__esModule&&Object.prototype.hasOwnProperty.call(r,"default")?r.default:r}var C={exports:{}},J=C.exports,j;function W(){return j||(j=1,(function(r,s){(function(t,i){i(r)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:J,function(t){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)t.exports=globalThis.browser;else{const i="The message port closed before a response was received.",o=A=>{const p={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(p).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class T extends WeakMap{constructor(n,g=void 0){super(g),this.createItem=n}get(n){return this.has(n)||this.set(n,this.createItem(n)),super.get(n)}}const X=e=>e&&typeof e=="object"&&typeof e.then=="function",B=(e,n)=>(...g)=>{A.runtime.lastError?e.reject(new Error(A.runtime.lastError.message)):n.singleCallbackArg||g.length<=1&&n.singleCallbackArg!==!1?e.resolve(g[0]):e.resolve(g)},S=e=>e==1?"argument":"arguments",ee=(e,n)=>function(m,...u){if(u.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${S(n.minArgs)} for ${e}(), got ${u.length}`);if(u.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${S(n.maxArgs)} for ${e}(), got ${u.length}`);return new Promise((x,d)=>{if(n.fallbackToNoCallback)try{m[e](...u,B({resolve:x,reject:d},n))}catch(a){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,a),m[e](...u),n.fallbackToNoCallback=!1,n.noCallback=!0,x()}else n.noCallback?(m[e](...u),x()):m[e](...u,B({resolve:x,reject:d},n))})},F=(e,n,g)=>new Proxy(n,{apply(m,u,x){return g.call(u,e,...x)}});let E=Function.call.bind(Object.prototype.hasOwnProperty);const v=(e,n={},g={})=>{let m=Object.create(null),u={has(d,a){return a in e||a in m},get(d,a,f){if(a in m)return m[a];if(!(a in e))return;let l=e[a];if(typeof l=="function")if(typeof n[a]=="function")l=F(e,e[a],n[a]);else if(E(g,a)){let w=ee(a,g[a]);l=F(e,e[a],w)}else l=l.bind(e);else if(typeof l=="object"&&l!==null&&(E(n,a)||E(g,a)))l=v(l,n[a],g[a]);else if(E(g,"*"))l=v(l,n[a],g["*"]);else return Object.defineProperty(m,a,{configurable:!0,enumerable:!0,get(){return e[a]},set(w){e[a]=w}}),l;return m[a]=l,l},set(d,a,f,l){return a in m?m[a]=f:e[a]=f,!0},defineProperty(d,a,f){return Reflect.defineProperty(m,a,f)},deleteProperty(d,a){return Reflect.deleteProperty(m,a)}},x=Object.create(e);return new Proxy(x,u)},U=e=>({addListener(n,g,...m){n.addListener(e.get(g),...m)},hasListener(n,g){return n.hasListener(e.get(g))},removeListener(n,g){n.removeListener(e.get(g))}}),re=new T(e=>typeof e!="function"?e:function(g){const m=v(g,{},{getContent:{minArgs:0,maxArgs:0}});e(m)}),O=new T(e=>typeof e!="function"?e:function(g,m,u){let x=!1,d,a=new Promise(y=>{d=function(b){x=!0,y(b)}}),f;try{f=e(g,m,d)}catch(y){f=Promise.reject(y)}const l=f!==!0&&X(f);if(f!==!0&&!l&&!x)return!1;const w=y=>{y.then(b=>{u(b)},b=>{let $;b&&(b instanceof Error||typeof b.message=="string")?$=b.message:$="An unexpected error occurred",u({__mozWebExtensionPolyfillReject__:!0,message:$})}).catch(b=>{console.error("Failed to send onMessage rejected reply",b)})};return w(l?f:a),!0}),se=({reject:e,resolve:n},g)=>{A.runtime.lastError?A.runtime.lastError.message===i?n():e(new Error(A.runtime.lastError.message)):g&&g.__mozWebExtensionPolyfillReject__?e(new Error(g.message)):n(g)},D=(e,n,g,...m)=>{if(m.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${S(n.minArgs)} for ${e}(), got ${m.length}`);if(m.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${S(n.maxArgs)} for ${e}(), got ${m.length}`);return new Promise((u,x)=>{const d=se.bind(null,{resolve:u,reject:x});m.push(d),g.sendMessage(...m)})},ne={devtools:{network:{onRequestFinished:U(re)}},runtime:{onMessage:U(O),onMessageExternal:U(O),sendMessage:D.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:D.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},_={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return p.privacy={network:{"*":_},services:{"*":_},websites:{"*":_}},v(A,ne,p)};t.exports=o(chrome)}})})(C)),C.exports}var K=W();const c=q(K);function I(r){return r==null||typeof r=="function"?{main:r}:r}const L="ccc_config";async function R(){return(await c.storage.local.get(L))[L]??{baseUrl:"http://localhost:21425",apiKey:"",szuruUser:""}}async function z(r,s){var p;const t=await R(),i={"Content-Type":"application/json",Accept:"application/json"};t.apiKey&&(i["X-API-Key"]=t.apiKey);const o={url:r};s!=null&&s.source&&(o.source=s.source),(p=s==null?void 0:s.tags)!=null&&p.length&&(o.tags=s.tags),s!=null&&s.safety&&(o.safety=s.safety),s!=null&&s.skipTagging&&(o.skip_tagging=s.skipTagging),t.szuruUser&&(o.szuru_user=t.szuruUser);const A=await fetch(`${t.baseUrl}/api/jobs`,{method:"POST",headers:i,body:JSON.stringify(o)});if(!A.ok){const T=await A.text();throw new Error(`CCC returned ${A.status}: ${T}`)}return A.json()}async function Y(r){const s=await R(),t={Accept:"application/json"};s.apiKey&&(t["X-API-Key"]=s.apiKey);const i=await fetch(`${s.baseUrl}/api/jobs/${r}`,{headers:t});if(!i.ok){const o=await i.text();throw new Error(`CCC returned ${i.status}: ${o}`)}return i.json()}const Z=3e3,N=600*1e3;function G(r,s){const t="ccc-toast-"+Date.now(),i=document.createElement("div");i.id=t,i.textContent=r,i.style.cssText=["position:fixed","bottom:24px","right:24px","max-width:320px","padding:12px 16px","border-radius:8px","font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif","font-size:14px","font-weight:500","box-shadow:0 4px 12px rgba(0,0,0,0.25)","z-index:2147483647","pointer-events:none",s==="success"?"background:#22c55e":"background:#ef4444","color:#fff"].join(";");const o=document.createElement("style");o.textContent="@keyframes ccc-toast-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}",document.head.appendChild(o),document.body.appendChild(i),i.style.animation="ccc-toast-in 0.2s ease",setTimeout(()=>{i.style.opacity="0",i.style.transition="opacity 0.2s ease",setTimeout(()=>{i.remove(),o.remove()},200)},4e3)}async function h(r,s,t,i){if(c.notifications&&c.notifications.create({type:"basic",iconUrl:c.runtime.getURL("icon/128.png"),title:s,message:r.slice(0,200)}),c.scripting&&i)try{await c.scripting.executeScript({target:{tabId:i},func:G,args:[r,t]})}catch{}}async function P(r,s,t){var i;try{const o=await Y(r);if(o.status==="completed"){const A=o.szuru_post_id?`Uploaded to Szurubooru (post #${o.szuru_post_id})`:"Upload complete.";await h(A,"Szurubooru Companion","success",s);return}if(o.status==="failed"){const A=((i=o.error_message)==null?void 0:i.slice(0,200))||"Upload failed.";await h(A,"Szurubooru Companion – Failed","error",s);return}if(o.status==="paused"||o.status==="stopped"){await h(`Job was ${o.status}.`,"Szurubooru Companion","error",s);return}}catch(o){if(console.error("[CCC] Poll error:",o),Date.now()-t>N){await h("Job status check timed out.","Szurubooru Companion","error",s);return}}if(Date.now()-t>N){await h("Job is still processing. Check the SzuruCompanion Dashboard.","Szurubooru Companion","error",s);return}setTimeout(()=>P(r,s,t),Z)}async function V(r,s){try{const t=await z(r.url,{source:r.source,tags:r.tags,safety:r.safety});return console.log("[CCC] Job created from content script:",t.id,r),c.notifications&&c.notifications.create({type:"basic",iconUrl:c.runtime.getURL("icon/128.png"),title:"Szurubooru Companion",message:"Queued. You'll be notified when it finishes."}),P(t.id,s,Date.now()),{success:!0,jobId:t.id}}catch(t){const i=t instanceof Error?t.message:String(t);return console.error("[CCC] Failed to submit job from content script:",t),await h(i.slice(0,200),"Szurubooru Companion – Error","error",s),{success:!1,error:i}}}const H=I(()=>{c.runtime.onInstalled.addListener(()=>{c.contextMenus.create({id:"ccc-send-image",title:"Send to Szurubooru",contexts:["image","video"]}),c.contextMenus.create({id:"ccc-send-link",title:"Send link to Szurubooru",contexts:["link"]}),c.contextMenus.create({id:"ccc-send-page",title:"Send page URL to Szurubooru",contexts:["page"]})}),c.contextMenus.onClicked.addListener(async(r,s)=>{let t;switch(r.menuItemId){case"ccc-send-image":t=(s==null?void 0:s.url)??r.srcUrl;break;case"ccc-send-link":t=r.linkUrl;break;case"ccc-send-page":t=r.pageUrl??(s==null?void 0:s.url);break}if(!t)return;const i=s==null?void 0:s.id;try{const o=await z(t);console.log("[CCC] Job created:",o.id),c.notifications&&c.notifications.create({type:"basic",iconUrl:c.runtime.getURL("icon/128.png"),title:"Szurubooru Companion",message:"Queued. You'll be notified when it finishes."}),P(o.id,i,Date.now())}catch(o){const A=o instanceof Error?o.message:String(o);console.error("[CCC] Failed to submit job:",o),await h(A.slice(0,200),"Szurubooru Companion – Error","error",i)}}),c.runtime.onMessage.addListener((r,s,t)=>{var i;return r.action==="SUBMIT_JOB"?(V(r.payload,(i=s.tab)==null?void 0:i.id).then(t).catch(o=>{t({success:!1,error:o.message})}),!0):!1})});function ie(){}function k(r,...s){}const Q={debug:(...r)=>k(console.debug,...r),log:(...r)=>k(console.log,...r),warn:(...r)=>k(console.warn,...r),error:(...r)=>k(console.error,...r)};let M;try{M=H.main(),M instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(r){throw Q.error("The background crashed on startup!"),r}return M})();
background;
