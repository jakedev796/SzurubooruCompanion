var background=(function(){"use strict";function H(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var T={exports:{}},Z=T.exports,N;function V(){return N||(N=1,(function(e,r){(function(a,t){t(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:Z,function(a){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)a.exports=globalThis.browser;else{const t="The message port closed before a response was received.",o=l=>{const w={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(w).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class k extends WeakMap{constructor(n,g=void 0){super(g),this.createItem=n}get(n){return this.has(n)||this.set(n,this.createItem(n)),super.get(n)}}const oe=s=>s&&typeof s=="object"&&typeof s.then=="function",Y=(s,n)=>(...g)=>{l.runtime.lastError?s.reject(new Error(l.runtime.lastError.message)):n.singleCallbackArg||g.length<=1&&n.singleCallbackArg!==!1?s.resolve(g[0]):s.resolve(g)},v=s=>s==1?"argument":"arguments",ie=(s,n)=>function(c,...u){if(u.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${v(n.minArgs)} for ${s}(), got ${u.length}`);if(u.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${v(n.maxArgs)} for ${s}(), got ${u.length}`);return new Promise((f,d)=>{if(n.fallbackToNoCallback)try{c[s](...u,Y({resolve:f,reject:d},n))}catch(i){console.warn(`${s} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,i),c[s](...u),n.fallbackToNoCallback=!1,n.noCallback=!0,f()}else n.noCallback?(c[s](...u),f()):c[s](...u,Y({resolve:f,reject:d},n))})},I=(s,n,g)=>new Proxy(n,{apply(c,u,f){return g.call(u,s,...f)}});let P=Function.call.bind(Object.prototype.hasOwnProperty);const _=(s,n={},g={})=>{let c=Object.create(null),u={has(d,i){return i in s||i in c},get(d,i,x){if(i in c)return c[i];if(!(i in s))return;let A=s[i];if(typeof A=="function")if(typeof n[i]=="function")A=I(s,s[i],n[i]);else if(P(g,i)){let p=ie(i,g[i]);A=I(s,s[i],p)}else A=A.bind(s);else if(typeof A=="object"&&A!==null&&(P(n,i)||P(g,i)))A=_(A,n[i],g[i]);else if(P(g,"*"))A=_(A,n[i],g["*"]);else return Object.defineProperty(c,i,{configurable:!0,enumerable:!0,get(){return s[i]},set(p){s[i]=p}}),A;return c[i]=A,A},set(d,i,x,A){return i in c?c[i]=x:s[i]=x,!0},defineProperty(d,i,x){return Reflect.defineProperty(c,i,x)},deleteProperty(d,i){return Reflect.deleteProperty(c,i)}},f=Object.create(s);return new Proxy(f,u)},O=s=>({addListener(n,g,...c){n.addListener(s.get(g),...c)},hasListener(n,g){return n.hasListener(s.get(g))},removeListener(n,g){n.removeListener(s.get(g))}}),ge=new k(s=>typeof s!="function"?s:function(g){const c=_(g,{},{getContent:{minArgs:0,maxArgs:0}});s(c)}),G=new k(s=>typeof s!="function"?s:function(g,c,u){let f=!1,d,i=new Promise(C=>{d=function(b){f=!0,C(b)}}),x;try{x=s(g,c,d)}catch(C){x=Promise.reject(C)}const A=x!==!0&&oe(x);if(x!==!0&&!A&&!f)return!1;const p=C=>{C.then(b=>{u(b)},b=>{let L;b&&(b instanceof Error||typeof b.message=="string")?L=b.message:L="An unexpected error occurred",u({__mozWebExtensionPolyfillReject__:!0,message:L})}).catch(b=>{console.error("Failed to send onMessage rejected reply",b)})};return p(A?x:i),!0}),ce=({reject:s,resolve:n},g)=>{l.runtime.lastError?l.runtime.lastError.message===t?n():s(new Error(l.runtime.lastError.message)):g&&g.__mozWebExtensionPolyfillReject__?s(new Error(g.message)):n(g)},K=(s,n,g,...c)=>{if(c.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${v(n.minArgs)} for ${s}(), got ${c.length}`);if(c.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${v(n.maxArgs)} for ${s}(), got ${c.length}`);return new Promise((u,f)=>{const d=ce.bind(null,{resolve:u,reject:f});c.push(d),g.sendMessage(...c)})},le={devtools:{network:{onRequestFinished:O(ge)}},runtime:{onMessage:O(G),onMessageExternal:O(G),sendMessage:K.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:K.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},R={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return w.privacy={network:{"*":R},services:{"*":R},websites:{"*":R}},_(l,le,w)};a.exports=o(chrome)}})})(T)),T.exports}var Q=V();const m=H(Q);function X(e){return e==null||typeof e=="function"?{main:e}:e}const F="ccc_config",y="ccc_auth",z="ccc_notifications_enabled",B="ccc_default_safety";async function D(){const r=(await m.storage.local.get(B))[B];return r==="safe"||r==="sketchy"||r==="unsafe"?r:"unsafe"}async function $(){return(await m.storage.local.get(z))[z]!==!1}async function M(){return(await m.storage.local.get(F))[F]??{baseUrl:""}}async function J(){const r=(await m.storage.local.get(y))[y];if(!r)return null;const a=await M(),t=await fetch(`${a.baseUrl}/api/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:r.refreshToken})});if(!t.ok)return null;const l={accessToken:(await t.json()).access_token,refreshToken:r.refreshToken};return await m.storage.local.set({[y]:l}),l}async function S(){const e={"Content-Type":"application/json",Accept:"application/json"},a=(await m.storage.local.get(y))[y];return a&&(e.Authorization=`Bearer ${a.accessToken}`),e}async function q(e,r){var w;const a=await M();let t=await S();const o={url:e};r!=null&&r.source&&(o.source=r.source),(w=r==null?void 0:r.tags)!=null&&w.length&&(o.tags=r.tags),r!=null&&r.safety&&(o.safety=r.safety),r!=null&&r.skipTagging&&(o.skip_tagging=r.skipTagging);let l=await fetch(`${a.baseUrl}/api/jobs`,{method:"POST",headers:t,body:JSON.stringify(o)});if(l.status===401)if(await J())t=await S(),l=await fetch(`${a.baseUrl}/api/jobs`,{method:"POST",headers:t,body:JSON.stringify(o)});else throw new Error("Authentication expired. Please log in again.");if(!l.ok){const k=await l.text();throw new Error(`CCC returned ${l.status}: ${k}`)}return l.json()}async function ee(e){const r=await M();let a=await S(),t=await fetch(`${r.baseUrl}/api/jobs/${e}`,{headers:a});if(t.status===401)if(await J())a=await S(),t=await fetch(`${r.baseUrl}/api/jobs/${e}`,{headers:a});else throw new Error("Authentication expired. Please log in again.");if(!t.ok){const o=await t.text();throw new Error(`CCC returned ${t.status}: ${o}`)}return t.json()}const re=3e3,W=600*1e3;function se(e,r){const a="ccc-toast-"+Date.now(),t=document.createElement("div");t.id=a,t.textContent=e,t.style.cssText=["position:fixed","bottom:24px","right:24px","max-width:320px","padding:12px 16px","border-radius:8px","font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif","font-size:14px","font-weight:500","box-shadow:0 4px 12px rgba(0,0,0,0.25)","z-index:2147483647","pointer-events:none",r==="success"?"background:#22c55e":"background:#ef4444","color:#fff"].join(";");const o=document.createElement("style");o.textContent="@keyframes ccc-toast-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}",document.head.appendChild(o),document.body.appendChild(t),t.style.animation="ccc-toast-in 0.2s ease",setTimeout(()=>{t.style.opacity="0",t.style.transition="opacity 0.2s ease",setTimeout(()=>{t.remove(),o.remove()},200)},4e3)}async function h(e,r,a,t){if(await $()&&m.notifications&&m.notifications.create({type:"basic",iconUrl:m.runtime.getURL("icon/128.png"),title:r,message:e.slice(0,200)}),m.scripting&&t)try{await m.scripting.executeScript({target:{tabId:t},func:se,args:[e,a]})}catch{}}async function U(e,r,a){var t;try{const o=await ee(e);if(o.status==="completed"){const l=o.szuru_post_id?`Uploaded to Szurubooru (post #${o.szuru_post_id})`:"Upload complete.";await h(l,"Szurubooru Companion","success",r);return}if(o.status==="failed"){const l=((t=o.error_message)==null?void 0:t.slice(0,200))||"Upload failed.";await h(l,"Szurubooru Companion – Failed","error",r);return}if(o.status==="paused"||o.status==="stopped"){await h(`Job was ${o.status}.`,"Szurubooru Companion","error",r);return}}catch(o){if(console.error("[CCC] Poll error:",o),Date.now()-a>W){await h("Job status check timed out.","Szurubooru Companion","error",r);return}}if(Date.now()-a>W){await h("Job is still processing. Check the SzuruCompanion Dashboard.","Szurubooru Companion","error",r);return}setTimeout(()=>U(e,r,a),re)}async function ne(e,r){try{const a=await D(),t=await q(e.url,{source:e.source,tags:e.tags,safety:e.safety??a});return console.log("[CCC] Job created from content script:",t.id,e),await $()&&m.notifications&&m.notifications.create({type:"basic",iconUrl:m.runtime.getURL("icon/128.png"),title:"Szurubooru Companion",message:"Queued. You'll be notified when it finishes."}),U(t.id,r,Date.now()),{success:!0,jobId:t.id}}catch(a){const t=a instanceof Error?a.message:String(a);return console.error("[CCC] Failed to submit job from content script:",a),await h(t.slice(0,200),"Szurubooru Companion – Error","error",r),{success:!1,error:t}}}const te=X(()=>{m.runtime.onInstalled.addListener(()=>{m.contextMenus.create({id:"ccc-send-image",title:"Send to Szurubooru",contexts:["image","video"]}),m.contextMenus.create({id:"ccc-send-link",title:"Send link to Szurubooru",contexts:["link"]}),m.contextMenus.create({id:"ccc-send-page",title:"Send page URL to Szurubooru",contexts:["page"]})}),m.contextMenus.onClicked.addListener(async(e,r)=>{let a;switch(e.menuItemId){case"ccc-send-image":a=(r==null?void 0:r.url)??e.srcUrl;break;case"ccc-send-link":a=e.linkUrl;break;case"ccc-send-page":a=e.pageUrl??(r==null?void 0:r.url);break}if(!a)return;const t=r==null?void 0:r.id;try{const o=await D(),l=await q(a,{safety:o});console.log("[CCC] Job created:",l.id),await $()&&m.notifications&&m.notifications.create({type:"basic",iconUrl:m.runtime.getURL("icon/128.png"),title:"Szurubooru Companion",message:"Queued. You'll be notified when it finishes."}),U(l.id,t,Date.now())}catch(o){const l=o instanceof Error?o.message:String(o);console.error("[CCC] Failed to submit job:",o),await h(l.slice(0,200),"Szurubooru Companion – Error","error",t)}}),m.runtime.onMessage.addListener((e,r,a)=>{var t;return e.action==="SUBMIT_JOB"?(ne(e.payload,(t=r.tab)==null?void 0:t.id).then(a).catch(o=>{a({success:!1,error:o.message})}),!0):!1})});function Ae(){}function E(e,...r){}const ae={debug:(...e)=>E(console.debug,...e),log:(...e)=>E(console.log,...e),warn:(...e)=>E(console.warn,...e),error:(...e)=>E(console.error,...e)};let j;try{j=te.main(),j instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw ae.error("The background crashed on startup!"),e}return j})();
background;
