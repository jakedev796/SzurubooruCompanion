var content=(function(){"use strict";var rt=Object.defineProperty;var st=(M,S,q)=>S in M?rt(M,S,{enumerable:!0,configurable:!0,writable:!0,value:q}):M[S]=q;var L=(M,S,q)=>st(M,typeof S!="symbol"?S+"":S,q);function M(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var S={exports:{}},q=S.exports,Y;function ne(){return Y||(Y=1,(function(e,t){(function(s,r){r(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:q,function(s){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)s.exports=globalThis.browser;else{const r="The message port closed before a response was received.",n=o=>{const a={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(a).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class i extends WeakMap{constructor(l,f=void 0){super(f),this.createItem=l}get(l){return this.has(l)||this.set(l,this.createItem(l)),super.get(l)}}const u=c=>c&&typeof c=="object"&&typeof c.then=="function",d=(c,l)=>(...f)=>{o.runtime.lastError?c.reject(new Error(o.runtime.lastError.message)):l.singleCallbackArg||f.length<=1&&l.singleCallbackArg!==!1?c.resolve(f[0]):c.resolve(f)},g=c=>c==1?"argument":"arguments",A=(c,l)=>function(h,...w){if(w.length<l.minArgs)throw new Error(`Expected at least ${l.minArgs} ${g(l.minArgs)} for ${c}(), got ${w.length}`);if(w.length>l.maxArgs)throw new Error(`Expected at most ${l.maxArgs} ${g(l.maxArgs)} for ${c}(), got ${w.length}`);return new Promise((v,C)=>{if(l.fallbackToNoCallback)try{h[c](...w,d({resolve:v,reject:C},l))}catch(m){console.warn(`${c} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,m),h[c](...w),l.fallbackToNoCallback=!1,l.noCallback=!0,v()}else l.noCallback?(h[c](...w),v()):h[c](...w,d({resolve:v,reject:C},l))})},b=(c,l,f)=>new Proxy(l,{apply(h,w,v){return f.call(w,c,...v)}});let x=Function.call.bind(Object.prototype.hasOwnProperty);const E=(c,l={},f={})=>{let h=Object.create(null),w={has(C,m){return m in c||m in h},get(C,m,k){if(m in h)return h[m];if(!(m in c))return;let y=c[m];if(typeof y=="function")if(typeof l[m]=="function")y=b(c,c[m],l[m]);else if(x(f,m)){let $=A(m,f[m]);y=b(c,c[m],$)}else y=y.bind(c);else if(typeof y=="object"&&y!==null&&(x(l,m)||x(f,m)))y=E(y,l[m],f[m]);else if(x(f,"*"))y=E(y,l[m],f["*"]);else return Object.defineProperty(h,m,{configurable:!0,enumerable:!0,get(){return c[m]},set($){c[m]=$}}),y;return h[m]=y,y},set(C,m,k,y){return m in h?h[m]=k:c[m]=k,!0},defineProperty(C,m,k){return Reflect.defineProperty(h,m,k)},deleteProperty(C,m){return Reflect.deleteProperty(h,m)}},v=Object.create(c);return new Proxy(v,w)},K=c=>({addListener(l,f,...h){l.addListener(c.get(f),...h)},hasListener(l,f){return l.hasListener(c.get(f))},removeListener(l,f){l.removeListener(c.get(f))}}),Xe=new i(c=>typeof c!="function"?c:function(f){const h=E(f,{},{getContent:{minArgs:0,maxArgs:0}});c(h)}),re=new i(c=>typeof c!="function"?c:function(f,h,w){let v=!1,C,m=new Promise(B=>{C=function(I){v=!0,B(I)}}),k;try{k=c(f,h,C)}catch(B){k=Promise.reject(B)}const y=k!==!0&&u(k);if(k!==!0&&!y&&!v)return!1;const $=B=>{B.then(I=>{w(I)},I=>{let Z;I&&(I instanceof Error||typeof I.message=="string")?Z=I.message:Z="An unexpected error occurred",w({__mozWebExtensionPolyfillReject__:!0,message:Z})}).catch(I=>{console.error("Failed to send onMessage rejected reply",I)})};return $(y?k:m),!0}),et=({reject:c,resolve:l},f)=>{o.runtime.lastError?o.runtime.lastError.message===r?l():c(new Error(o.runtime.lastError.message)):f&&f.__mozWebExtensionPolyfillReject__?c(new Error(f.message)):l(f)},se=(c,l,f,...h)=>{if(h.length<l.minArgs)throw new Error(`Expected at least ${l.minArgs} ${g(l.minArgs)} for ${c}(), got ${h.length}`);if(h.length>l.maxArgs)throw new Error(`Expected at most ${l.maxArgs} ${g(l.maxArgs)} for ${c}(), got ${h.length}`);return new Promise((w,v)=>{const C=et.bind(null,{resolve:w,reject:v});h.push(C),f.sendMessage(...h)})},tt={devtools:{network:{onRequestFinished:K(Xe)}},runtime:{onMessage:K(re),onMessageExternal:K(re),sendMessage:se.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:se.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},W={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return a.privacy={network:{"*":W},services:{"*":W},websites:{"*":W}},E(o,tt,a)};s.exports=n(chrome)}})})(S)),S.exports}var ae=ne();const _=M(ae);function at(e){return e}function U(e){try{const r=new URL(e).pathname.split("/").filter(Boolean);if(r.length>0){const o=r[r.length-1].split("?")[0].split("#")[0];if(o&&o.length>0)return o}}catch{}return`media_${Date.now()}`}function T(e){return e.trim().toLowerCase().replace(/\s+/g,"_").replace(/[^\w\-_:]/g,"").slice(0,64)}function J(e){const t=[],s=e.matchAll(/#(\w+)/g);for(const r of s){const n=T(r[1]);n.length>=2&&t.push(n)}return[...new Set(t)]}function oe(e){var t;if(e.tagName==="IMG")return e.src;if(e.tagName==="VIDEO"){const s=e;return s.currentSrc||s.poster||((t=s.querySelector("source"))==null?void 0:t.src)||null}return null}function R(e,t){if(e.tagName==="VIDEO")return!0;const s=[".mp4",".webm",".mov",".gifv"],r=t.toLowerCase();return s.some(n=>r.includes(n))||t.startsWith("blob:")}const z="szuru-companion-grab-btn",ie=200,ce=100,p={currentMedia:null,hoverTimeout:null,isButtonHovered:!1};function le(){return`
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
      <polyline points="17 8 12 3 7 8"/>
      <line x1="12" y1="3" x2="12" y2="15"/>
    </svg>
  `}function Q(){let e=document.getElementById(z);return e||(e=document.createElement("button"),e.id=z,e.innerHTML=le(),e.title="Send to Szurubooru",e.type="button",Object.assign(e.style,{position:"fixed",width:"32px",height:"32px",borderRadius:"50%",background:"#6366f1",color:"white",border:"2px solid white",cursor:"pointer",zIndex:"2147483647",boxShadow:"0 2px 8px rgba(0,0,0,0.3)",display:"none",alignItems:"center",justifyContent:"center",transition:"transform 0.15s ease, opacity 0.15s ease, background 0.15s ease",opacity:"0",pointerEvents:"auto",padding:"0",margin:"0",boxSizing:"border-box"}),e.addEventListener("mouseenter",()=>{e.style.background="#4f46e5",e.style.transform="scale(1.1)",p.isButtonHovered=!0,p.hoverTimeout&&(clearTimeout(p.hoverTimeout),p.hoverTimeout=null)}),e.addEventListener("mouseleave",()=>{e.style.background="#6366f1",e.style.transform="scale(1)",p.isButtonHovered=!1,ee()}),e.addEventListener("mousedown",()=>{e.style.transform="scale(0.95)"}),e.addEventListener("mouseup",()=>{e.style.transform="scale(1.1)"}),document.body.appendChild(e)),e}function X(e,t){const s=t.getBoundingClientRect(),r=Math.max(8,s.top+8),n=Math.max(8,s.left+8),o=window.innerWidth-40,a=window.innerHeight-40;e.style.top=`${Math.min(r,a)}px`,e.style.left=`${Math.min(n,o)}px`,e.style.display="flex",e.offsetHeight,e.style.opacity="1"}function ee(){p.hoverTimeout&&clearTimeout(p.hoverTimeout),p.hoverTimeout=setTimeout(()=>{p.isButtonHovered||ue()},ce)}function ue(){const e=document.getElementById(z);e&&(e.style.opacity="0",setTimeout(()=>{e.style.opacity==="0"&&(e.style.display="none")},150)),p.currentMedia=null}function ge(e){const t=Q();X(t,e),p.currentMedia=e}function me(e){if(e.tagName==="IMG"){const t=e,s=t.src;if(!t.complete||t.naturalWidth<50||t.naturalHeight<50)return!1;const r=[/\/profile_images\//i,/\/avatar/i,/\/emoji\//i,/\/hashflags\//i,/\/badge/i,/\/icon/i,/_normal\./i,/_bigger\./i,/_mini\./i];for(const n of r)if(n.test(s))return!1;return!0}return e.tagName==="VIDEO"?e.readyState>=1:!1}function de(e){const t=Q(),s=a=>{a.preventDefault(),a.stopPropagation(),p.currentMedia&&(t.style.background="#22c55e",setTimeout(()=>{t.style.background="#6366f1"},200),e(p.currentMedia))};t.addEventListener("click",s);const r=a=>{const i=a.target;me(i)&&(p.hoverTimeout&&(clearTimeout(p.hoverTimeout),p.hoverTimeout=null),p.hoverTimeout=setTimeout(()=>{ge(i)},ie))},n=a=>{const i=a.target;p.currentMedia===i&&ee()},o=()=>{if(p.currentMedia&&!p.isButtonHovered){const a=document.getElementById(z);a&&a.style.display!=="none"&&X(a,p.currentMedia)}};return document.addEventListener("mouseover",r),document.addEventListener("mouseout",n),window.addEventListener("scroll",o,{passive:!0}),()=>{t.removeEventListener("click",s),document.removeEventListener("mouseover",r),document.removeEventListener("mouseout",n),window.removeEventListener("scroll",o),p.hoverTimeout&&clearTimeout(p.hoverTimeout),t.remove()}}function N(e,t){const s="ccc-toast-"+Date.now(),r=document.createElement("div");r.id=s,r.textContent=e;const n={success:"#22c55e",error:"#ef4444",info:"#3b82f6"};r.style.cssText=["position:fixed","bottom:24px","right:24px","max-width:320px","padding:12px 16px","border-radius:8px",'font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif',"font-size:14px","font-weight:500","box-shadow:0 4px 12px rgba(0,0,0,0.25)","z-index:2147483647","pointer-events:none",`background:${n[t]}`,"color:#fff"].join(";");const o=document.createElement("style");o.textContent="@keyframes ccc-toast-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}",document.head.appendChild(o),document.body.appendChild(r),r.style.animation="ccc-toast-in 0.2s ease",setTimeout(()=>{r.style.opacity="0",r.style.transition="opacity 0.2s ease",setTimeout(()=>{r.remove(),o.remove()},200)},4e3)}const fe=["misskey.io","misskey.art","misskey.net","misskey.design","misskey.xyz","mi.0px.io","misskey.pizza","misskey.cloud","misskey.st","misskey.id"];function he(e){try{const t=new URL(e).hostname;return fe.some(s=>t===s||t.endsWith("."+s))}catch{return!1}}function Ae(e){const t=e.closest("[data-note-id]");if(t){const o=t.getAttribute("data-note-id");if(o)return o}const s=e.closest("article[data-id]");if(s){const o=s.getAttribute("data-id");if(o)return o}const r=e.closest('a[href*="/notes/"]')||e.querySelector('a[href*="/notes/"]');if(r){const o=r.getAttribute("href");if(o){const a=o.match(/\/notes\/([a-zA-Z0-9]+)/);if(a)return a[1]}}const n=e.closest('article, [class*="note"], [class*="post"]');if(n){const o=n.querySelectorAll('a[href*="/notes/"]');for(const a of o){const i=a.getAttribute("href");if(i){const u=i.match(/\/notes\/([a-zA-Z0-9]+)/);if(u)return u[1]}}}return null}function pe(e){var d,g;const t=e.closest('article, [class*="note"], [class*="post"]');if(!t)return null;const r=t.querySelector('[class*="renote"], [class*="quote"]')||t,n=r.querySelector(`
    [class*="avatar"] + [class*="name"],
    [class*="header"] [class*="name"],
    [class*="user"] [class*="name"],
    header a[href*="/@"]
  `);if(n){const A=((d=n.textContent)==null?void 0:d.trim())||"",b=A.match(/@([a-zA-Z0-9_-]+)@([a-zA-Z0-9.-]+)/);if(b)return{username:b[1],host:b[2]};const x=A.match(/@([a-zA-Z0-9_-]+)/);if(x)return{username:x[1],host:""}}const o=r.querySelector('[class*="header"], header, [class*="top"]');if(o){const A=o.querySelector('a[href*="/@"]');if(A){const x=(A.getAttribute("href")||"").match(/\/@([a-zA-Z0-9_-]+)(?:@([a-zA-Z0-9.-]+))?/);if(x)return{username:x[1],host:x[2]||""}}}const a=r.querySelector('a[href*="/@"]:has(img[class*="avatar"]), a[href*="/@"] img[class*="avatar"]');if(a){const A=a.closest('a[href*="/@"]');if(A){const x=(A.getAttribute("href")||"").match(/\/@([a-zA-Z0-9_-]+)(?:@([a-zA-Z0-9.-]+))?/);if(x)return{username:x[1],host:x[2]||""}}}const i=r.querySelectorAll('a[href*="/@"]');for(const A of i){const b=A.getAttribute("href")||"";if(A.closest('[class*="text"], [class*="content"]'))continue;const E=b.match(/\/@([a-zA-Z0-9_-]+)(?:@([a-zA-Z0-9.-]+))?/);if(E)return{username:E[1],host:E[2]||""}}const u=r.querySelectorAll('[class*="userName"], [class*="username"], [class*="display-name"]');for(const A of u){const b=((g=A.textContent)==null?void 0:g.trim())||"",x=b.match(/@([a-zA-Z0-9_-]+)@([a-zA-Z0-9.-]+)/);if(x)return{username:x[1],host:x[2]};const E=b.match(/@([a-zA-Z0-9_-]+)/);if(E)return{username:E[1],host:""}}return null}function be(e){const t=e.closest('article, [class*="note"], [class*="post"]');if(!t)return["tagme"];const s=t.querySelectorAll('a[href*="/tags/"], a[href*="/tag/"]'),r=[];for(const i of s){const d=(i.getAttribute("href")||"").match(/\/tags?\/([a-zA-Z0-9_]+)/);d&&r.push(d[1].toLowerCase())}const n=t.textContent||"",o=J(n),a=[...new Set([...r,...o])];return a.length>0?a:["tagme"]}const xe={name:"misskey",matches(e){return he(e)},async extract(e,t){const s=window.location.href,r=new URL(s).hostname,n=Ae(e);if(!n)return console.log("[CCC] Misskey: Could not find note ID"),null;const o=`https://${r}/notes/${n}`,a=pe(e);let i=null;a&&(i=a.host?`https://${r}/@${a.username}@${a.host}`:`https://${r}/@${a.username}`);const u=be(e);a!=null&&a.username&&u.unshift(`artist:${a.username.toLowerCase()}`);const d=[];i&&i!==o&&d.push(i);const g=R(e,t);return{url:t,source:o,secondarySources:d.length>0?d:void 0,tags:u,safety:"safe",type:g?"video":"image",filename:U(t),metadata:{noteId:n,instance:r,username:a==null?void 0:a.username,userHost:a==null?void 0:a.host}}},findGrabbableMedia(){const e=[];return document.querySelectorAll(`
      article img,
      [data-note-id] img,
      [class*="note"] img,
      [class*="post"] img
    `).forEach(r=>{this.isGrabbable(r)&&e.push(r)}),document.querySelectorAll(`
      article video,
      [data-note-id] video,
      [class*="note"] video,
      [class*="post"] video
    `).forEach(r=>{e.push(r)}),e},isGrabbable(e){if(e.tagName!=="IMG"&&e.tagName!=="VIDEO"||!e.closest(`
      article,
      [data-note-id],
      [class*="note"],
      [class*="post"]
    `))return!1;if(e.tagName==="IMG"){const s=e;if(!s.complete||s.naturalWidth<50||s.naturalHeight<50)return!1;const r=s.src;if(r.includes("/avatar")||r.includes("/icon"))return!1}return!0}};function ye(e){return/twitter\.com|x\.com/.test(e)}function we(e){const t=e.closest('article, [data-testid="tweet"], [role="article"]');if(t){const n=t.querySelectorAll('a[href*="/status/"]');for(const i of n){const u=i.getAttribute("href");if(u){const d=u.match(/\/status\/(\d+)/);if(d&&!(i.textContent||"").match(/^@\w+$/))return d[1]}}const o=t.getAttribute("data-tweet-id");if(o)return o;const a=t.querySelector("time");if(a){const i=a.closest('a[href*="/status/"]');if(i){const u=i.getAttribute("href");if(u){const d=u.match(/\/status\/(\d+)/);if(d)return d[1]}}}}const r=window.location.href.match(/\/status\/(\d+)/);return r?r[1]:null}function ve(e){const t=e.closest('article, [data-testid="tweet"], [role="article"]');if(!t)return null;if(t.querySelector('[data-testid="socialContext"]')){const o=(t.querySelector('[data-testid="tweet"]')||t).querySelectorAll('a[href^="/"]');for(const a of o){const u=(a.getAttribute("href")||"").match(/^\/([a-zA-Z0-9_]+)(?:\/|$)/);if(u&&!["status","i","home","explore","notifications","messages"].includes(u[1])&&a.closest('[data-testid="User-Name"], [class*="user"]'))return u[1]}}const r=t.querySelectorAll('a[href^="/"]');for(const n of r){const a=(n.getAttribute("href")||"").match(/^\/([a-zA-Z0-9_]+)(?:\/|$)/);if(a&&!["status","i","home","explore","notifications","messages"].includes(a[1])&&n.closest('[data-testid="User-Name"]'))return a[1]}for(const n of r){const a=(n.getAttribute("href")||"").match(/^\/([a-zA-Z0-9_]+)(?:\/|$)/);if(a&&!["status","i","home","explore","notifications","messages"].includes(a[1])&&!n.closest('[data-testid="tweetText"]'))return a[1]}return null}function Se(e){if(!e.includes("twimg.com"))return e;try{const t=new URL(e),s=t.searchParams.get("name");if(!s||["small","medium","large","thumb"].includes(s))return t.searchParams.set("name","orig"),t.toString()}catch{}return e}function Ce(e){var i;const t=e.closest('article, [data-testid="tweet"], [role="article"]');if(!t)return["tagme"];const s=t.querySelectorAll('a[href*="/hashtag/"]'),r=[];for(const u of s){const g=(u.getAttribute("href")||"").match(/\/hashtag\/([a-zA-Z0-9_]+)/);g&&r.push(g[1].toLowerCase())}const n=((i=t.querySelector('[data-testid="tweetText"]'))==null?void 0:i.textContent)||"",o=J(n),a=[...new Set([...r,...o])];return a.length>0?a:["tagme"]}function ke(e,t){return!!(e.tagName==="VIDEO"||t.startsWith("blob:")||t.includes("video.twimg.com")||t.includes(".mp4")||t.includes(".webm")||e.closest('[data-testid="videoPlayer"], [data-testid="previewInterstitial"]'))}const Ee={name:"twitter",matches(e){return ye(e)},async extract(e,t){const s=we(e);if(!s)return console.log("[CCC] Twitter: Could not find tweet ID"),null;const r=ve(e),n=r?`https://x.com/${r}/status/${s}`:`https://x.com/i/status/${s}`,o=ke(e,t);let a=t;!o&&t.includes("twimg.com")&&(a=Se(t));const i=Ce(e);return r&&i.unshift(`artist:${r.toLowerCase()}`),{url:o?n:a,source:n,tags:i,safety:"safe",type:o?"video":"image",filename:U(a),metadata:{tweetId:s,username:r,originalUrl:t,upgradedUrl:a!==t?a:void 0}}},findGrabbableMedia(){const e=[];return document.querySelectorAll(`
      article img,
      [data-testid="tweet"] img,
      [data-testid="tweetPhoto"] img
    `).forEach(r=>{this.isGrabbable(r)&&e.push(r)}),document.querySelectorAll(`
      article video,
      [data-testid="videoPlayer"] video,
      [data-testid="previewInterstitial"] video
    `).forEach(r=>{e.push(r)}),e},isGrabbable(e){if(e.tagName!=="IMG"&&e.tagName!=="VIDEO"||!e.closest(`
      article,
      [data-testid="tweet"],
      [data-testid="tweetPhoto"],
      [data-testid="videoPlayer"],
      [role="article"]
    `))return!1;if(e.tagName==="IMG"){const s=e,r=s.src;if(r.includes("/profile_images/")&&(r.includes("_normal.")||r.includes("_bigger.")||r.includes("_mini.")||r.includes("_200x200."))||r.includes("/emoji/")||r.includes("/hashflags/")||r.includes("/badge")||r.includes("/icon")||!s.complete||s.naturalWidth<50||s.naturalHeight<50)return!1}return!0}};function Te(e){return/danbooru\.donmai\.us|safebooru\.org/.test(e)}function Ie(){var o,a;const e=[];let t="safe";const s=(i,u)=>{document.querySelectorAll(i).forEach(d=>{var A;const g=d.querySelector('a.search-tag, a[href*="/posts?tags="]');if(g){const b=(A=g.textContent)==null?void 0:A.trim().replace(/ /g,"_");b&&b.length>=2&&e.push(`${u}:${T(b)}`)}})};s(".tag-type-artist","artist"),s(".tag-type-copyright","copyright"),s(".tag-type-character","character"),s(".tag-type-meta","meta"),document.querySelectorAll(".tag-type-general").forEach(i=>{var d;const u=i.querySelector('a.search-tag, a[href*="/posts?tags="]');if(u){const g=(d=u.textContent)==null?void 0:d.trim().replace(/ /g,"_");g&&g.length>=2&&e.push(T(g))}});const r=document.querySelector('.tag-type-rating a, [data-tag-category="rating"] a');if(r){const i=((o=r.textContent)==null?void 0:o.toLowerCase())||"";(i.includes("explicit")||i.includes("questionable"))&&(t=i.includes("explicit")?"unsafe":"sketchy")}const n=document.querySelector("#post-information, .post-info");if(n){const i=((a=n.textContent)==null?void 0:a.toLowerCase())||"";i.includes("rating: e")||i.includes("rating:explicit")?t="unsafe":(i.includes("rating: q")||i.includes("rating:questionable"))&&(t="sketchy")}return{tags:e,safety:t}}function Me(){const e=document.querySelector(`
    a[href*="//img"],
    a[href*="/original/"],
    a[href*="cdn.donmai.us"],
    #image-download-link,
    a[download]
  `);if(e){const r=e.getAttribute("href");if(r)return r}const t=document.querySelector("#image, .post-image img, [data-original-url]");if(t){const r=t.getAttribute("src")||t.getAttribute("data-original-url")||t.getAttribute("data-file-url");if(r)return r}const s=document.querySelector("script[data-post-id]");if(s){const n=(s.textContent||"").match(/"file_url"\s*:\s*"([^"]+)"/);if(n)return n[1].replace(/\\\//g,"/")}return null}function Le(){var s;const e=window.location.pathname.match(/\/posts\/(\d+)/);if(e)return e[1];const t=(s=document.querySelector("[data-post-id]"))==null?void 0:s.getAttribute("data-post-id");return t||null}const qe={name:"danbooru",matches(e){return Te(e)},async extract(e,t){const s=window.location.href,r=Me(),n=r||t,{tags:o,safety:a}=Ie(),i=Le(),u=R(e,n);return{url:n,source:s,tags:o.length>0?o:["tagme"],safety:a,type:u?"video":"image",filename:U(n),skipTagging:!0,metadata:{postId:i,originalUrl:r}}},findGrabbableMedia(){const e=[],t=document.querySelector("#image, .post-image img");return t&&e.push(t),document.querySelectorAll(".post-preview img, .post-thumbnail img").forEach(r=>{this.isGrabbable(r)&&e.push(r)}),e},isGrabbable(e){if(e.tagName!=="IMG"&&e.tagName!=="VIDEO")return!1;if(e.id==="image"||e.closest(".post-image"))return!0;if(e.closest(".post-preview, .post-thumbnail")){const t=e;return t.complete&&t.naturalWidth>=50}return!1}};function _e(e){return/gelbooru\.com/.test(e)}function Ne(){var o,a;const e=[];let t="safe";document.querySelectorAll(".tag-type").forEach(i=>{var A;const u=i.className,d=i.querySelector('a[href*="index.php?page=post&s=list&tags="]');if(!d)return;const g=(A=d.textContent)==null?void 0:A.trim().replace(/ /g,"_");!g||g.length<2||(u.includes("tag-type-artist")?e.push(`artist:${T(g)}`):u.includes("tag-type-copyright")?e.push(`copyright:${T(g)}`):u.includes("tag-type-character")?e.push(`character:${T(g)}`):u.includes("tag-type-metadata")?e.push(`meta:${T(g)}`):e.push(T(g)))});const r=document.querySelector('.tag-type-rating a, #stats li:contains("Rating")');if(r){const i=((o=r.textContent)==null?void 0:o.toLowerCase())||"";i.includes("explicit")?t="unsafe":i.includes("questionable")&&(t="sketchy")}const n=document.querySelector("#stats, .post-info");if(n){const i=((a=n.textContent)==null?void 0:a.toLowerCase())||"";i.includes("rating: explicit")||i.includes("rating:explicit")?t="unsafe":(i.includes("rating: questionable")||i.includes("rating:questionable"))&&(t="sketchy")}return{tags:e,safety:t}}function Pe(){const e=document.querySelector(`
    a[href*="//img"],
    a[href*="/images/"],
    #image-link,
    a[download],
    .original-file-notice a
  `);if(e){const r=e.getAttribute("href");if(r&&!r.includes("sample."))return r}const t=document.querySelector("#image, .post-image img, #main-image");if(t){const r=t.getAttribute("src");if(r&&!r.includes("sample."))return r;const n=t.getAttribute("data-original-url")||t.getAttribute("data-file-url");if(n)return n}const s=Array.from(document.querySelectorAll("a")).find(r=>{var n;return(n=r.textContent)==null?void 0:n.toLowerCase().includes("original")});if(s){const r=s.getAttribute("href");if(r)return r}return null}function $e(){var r;const t=new URLSearchParams(window.location.search).get("id");if(t)return t;const s=(r=document.querySelector("[data-id]"))==null?void 0:r.getAttribute("data-id");return s||null}const Ue={name:"gelbooru",matches(e){return _e(e)},async extract(e,t){const s=window.location.href,r=Pe(),n=r||t,{tags:o,safety:a}=Ne(),i=$e(),u=R(e,n);return{url:n,source:s,tags:o.length>0?o:["tagme"],safety:a,type:u?"video":"image",filename:U(n),skipTagging:!0,metadata:{postId:i,originalUrl:r}}},findGrabbableMedia(){const e=[],t=document.querySelector("#image, .post-image img, #main-image");return t&&e.push(t),document.querySelectorAll(".thumb img, .thumbnail img, .post-preview img").forEach(r=>{this.isGrabbable(r)&&e.push(r)}),e},isGrabbable(e){if(e.tagName!=="IMG"&&e.tagName!=="VIDEO")return!1;if(e.id==="image"||e.closest(".post-image"))return!0;if(e.closest(".thumb, .thumbnail, .post-preview")){const t=e;return t.complete&&t.naturalWidth>=50}return!1}};function Oe(e){return/yande\.re/.test(e)}function Be(){var o,a;const e=[];let t="safe";const s=(i,u)=>{document.querySelectorAll(i).forEach(d=>{var A;const g=d.querySelector('a[href*="/post?tags="], a[href*="/post/show/"]');if(g){const b=(A=g.textContent)==null?void 0:A.trim().replace(/ /g,"_");b&&b.length>=2&&e.push(`${u}:${T(b)}`)}})};s(".tag-type-artist","artist"),s(".tag-type-copyright","copyright"),s(".tag-type-character","character"),s(".tag-type-circle","circle"),s(".tag-type-faults","faults"),document.querySelectorAll(".tag-type-general, .tag-type-").forEach(i=>{var d;const u=i.querySelector('a[href*="/post?tags="]');if(u){const g=(d=u.textContent)==null?void 0:d.trim().replace(/ /g,"_");g&&g.length>=2&&e.push(T(g))}});const r=document.querySelector(".tag-type-rating a, #stats li");if(r){const i=((o=r.textContent)==null?void 0:o.toLowerCase())||"";i.includes("explicit")||i.includes("rating:e")?t="unsafe":(i.includes("questionable")||i.includes("rating:q"))&&(t="sketchy")}const n=document.querySelector("#stats, .post-info, .sidebar");if(n){const i=((a=n.textContent)==null?void 0:a.toLowerCase())||"";i.includes("rating: e")||i.includes("rating:explicit")?t="unsafe":(i.includes("rating: q")||i.includes("rating:questionable"))&&(t="sketchy")}return{tags:e,safety:t}}function Re(){const e=document.querySelector(`
    a[href*="//yande.re/image"],
    a[href*="/jpeg/"],
    a[href*="/png/"],
    #highres,
    a[download]
  `);if(e){const r=e.getAttribute("href");if(r)return r}const t=document.querySelector("#image, .post-image img, #main-image");if(t){const r=t.getAttribute("src");if(r&&!r.includes("sample."))return r;const n=t.getAttribute("data-original-url")||t.getAttribute("data-file-url");if(n)return n}const s=Array.from(document.querySelectorAll("a")).find(r=>{var n,o;return((n=r.textContent)==null?void 0:n.toLowerCase().includes("original"))||((o=r.textContent)==null?void 0:o.toLowerCase().includes("highres"))});if(s){const r=s.getAttribute("href");if(r)return r}return null}function ze(){var s;const e=window.location.pathname.match(/\/post\/show\/(\d+)/);if(e)return e[1];const t=(s=document.querySelector("[data-id]"))==null?void 0:s.getAttribute("data-id");return t||null}const Ge=[xe,Ee,qe,Ue,{name:"yande",matches(e){return Oe(e)},async extract(e,t){const s=window.location.href,r=Re(),n=r||t,{tags:o,safety:a}=Be(),i=ze(),u=R(e,n);return{url:n,source:s,tags:o.length>0?o:["tagme"],safety:a,type:u?"video":"image",filename:U(n),skipTagging:!0,metadata:{postId:i,originalUrl:r}}},findGrabbableMedia(){const e=[],t=document.querySelector("#image, .post-image img, #main-image");return t&&e.push(t),document.querySelectorAll(".thumb img, .preview img, .post-preview img").forEach(r=>{this.isGrabbable(r)&&e.push(r)}),e},isGrabbable(e){if(e.tagName!=="IMG"&&e.tagName!=="VIDEO")return!1;if(e.id==="image"||e.closest(".post-image"))return!0;if(e.closest(".thumb, .preview, .post-preview")){const t=e;return t.complete&&t.naturalWidth>=50}return!1}}];let P=null;function De(){const e=window.location.href;for(const t of Ge)if(t.matches(e))return t;return null}function Fe(e){const t=oe(e);if(t)return t;if(e.tagName!=="IMG"&&e.tagName!=="VIDEO"){const r=window.getComputedStyle(e).backgroundImage.match(/url\(['"]?([^'")]+)['"]?\)/);if(r)return r[1]}return null}async function Ve(e){if(!P){N("No extractor available for this page","error");return}const t=Fe(e);if(!t){N("Could not find media URL","error");return}console.log("[CCC] Extracting media from:",e.tagName,t);try{const s=await P.extract(e,t);if(!s){N("Could not extract media info","error");return}console.log("[CCC] Extracted media info:",s);const r={action:"SUBMIT_JOB",payload:s},n=await _.runtime.sendMessage(r);n&&n.success?N(`Job queued: ${n.jobId}`,"success"):N((n==null?void 0:n.error)||"Failed to submit job","error")}catch(s){console.error("[CCC] Error extracting media:",s),N(s instanceof Error?s.message:"Unknown error","error")}}function je(){new MutationObserver(t=>{for(const s of t)if(s.type==="childList"){for(const r of s.addedNodes)if(r instanceof HTMLElement&&(r.querySelectorAll("img, video").length>0||r.tagName==="IMG"||r.tagName==="VIDEO")){console.log("[CCC] New media elements detected");break}}}).observe(document.body,{childList:!0,subtree:!0})}function te(){if(console.log("[CCC] Content script initializing on:",window.location.href),P=De(),!P){console.log("[CCC] No extractor found for this page");return}console.log("[CCC] Using extractor:",P.name);const e=de(Ve);je();const t=P.findGrabbableMedia();console.log(`[CCC] Found ${t.length} grabbable media elements`),window.addEventListener("beforeunload",()=>{e()})}const He={matches:["*://*.twitter.com/*","*://*.x.com/*","*://*.misskey.io/*","*://*.misskey.art/*","*://*.misskey.net/*","*://*.misskey.design/*","*://*.misskey.xyz/*","*://*.mi.0px.io/*","*://*.misskey.pizza/*","*://*.misskey.cloud/*","*://danbooru.donmai.us/*","*://safebooru.org/*","*://*.gelbooru.com/*","*://yande.re/*"],runAt:"document_idle",main(){_.runtime.onMessage.addListener((e,t,s)=>e.action==="GET_PAGE_INFO"?(s({url:window.location.href,title:document.title}),!0):!1),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",te):te()}};function G(e,...t){}const Ke={debug:(...e)=>G(console.debug,...e),log:(...e)=>G(console.log,...e),warn:(...e)=>G(console.warn,...e),error:(...e)=>G(console.error,...e)},F=class F extends Event{constructor(t,s){super(F.EVENT_NAME,{}),this.newUrl=t,this.oldUrl=s}};L(F,"EVENT_NAME",j("wxt:locationchange"));let V=F;function j(e){var t;return`${(t=_==null?void 0:_.runtime)==null?void 0:t.id}:content:${e}`}function We(e){let t,s;return{run(){t==null&&(s=new URL(location.href),t=e.setInterval(()=>{let r=new URL(location.href);r.href!==s.href&&(window.dispatchEvent(new V(r,s)),s=r)},1e3))}}}const O=class O{constructor(t,s){L(this,"isTopFrame",window.self===window.top);L(this,"abortController");L(this,"locationWatcher",We(this));L(this,"receivedMessageIds",new Set);this.contentScriptName=t,this.options=s,this.abortController=new AbortController,this.isTopFrame?(this.listenForNewerScripts({ignoreFirstEvent:!0}),this.stopOldScripts()):this.listenForNewerScripts()}get signal(){return this.abortController.signal}abort(t){return this.abortController.abort(t)}get isInvalid(){return _.runtime.id==null&&this.notifyInvalidated(),this.signal.aborted}get isValid(){return!this.isInvalid}onInvalidated(t){return this.signal.addEventListener("abort",t),()=>this.signal.removeEventListener("abort",t)}block(){return new Promise(()=>{})}setInterval(t,s){const r=setInterval(()=>{this.isValid&&t()},s);return this.onInvalidated(()=>clearInterval(r)),r}setTimeout(t,s){const r=setTimeout(()=>{this.isValid&&t()},s);return this.onInvalidated(()=>clearTimeout(r)),r}requestAnimationFrame(t){const s=requestAnimationFrame((...r)=>{this.isValid&&t(...r)});return this.onInvalidated(()=>cancelAnimationFrame(s)),s}requestIdleCallback(t,s){const r=requestIdleCallback((...n)=>{this.signal.aborted||t(...n)},s);return this.onInvalidated(()=>cancelIdleCallback(r)),r}addEventListener(t,s,r,n){var o;s==="wxt:locationchange"&&this.isValid&&this.locationWatcher.run(),(o=t.addEventListener)==null||o.call(t,s.startsWith("wxt:")?j(s):s,r,{...n,signal:this.signal})}notifyInvalidated(){this.abort("Content script context invalidated"),Ke.debug(`Content script "${this.contentScriptName}" context invalidated`)}stopOldScripts(){window.postMessage({type:O.SCRIPT_STARTED_MESSAGE_TYPE,contentScriptName:this.contentScriptName,messageId:Math.random().toString(36).slice(2)},"*")}verifyScriptStartedEvent(t){var o,a,i;const s=((o=t.data)==null?void 0:o.type)===O.SCRIPT_STARTED_MESSAGE_TYPE,r=((a=t.data)==null?void 0:a.contentScriptName)===this.contentScriptName,n=!this.receivedMessageIds.has((i=t.data)==null?void 0:i.messageId);return s&&r&&n}listenForNewerScripts(t){let s=!0;const r=n=>{if(this.verifyScriptStartedEvent(n)){this.receivedMessageIds.add(n.data.messageId);const o=s;if(s=!1,o&&(t!=null&&t.ignoreFirstEvent))return;this.notifyInvalidated()}};addEventListener("message",r),this.onInvalidated(()=>removeEventListener("message",r))}};L(O,"SCRIPT_STARTED_MESSAGE_TYPE",j("wxt:content-script-started"));let H=O;const Ze=Symbol("null");let Ye=0;class Je extends Map{constructor(){super(),this._objectHashes=new WeakMap,this._symbolHashes=new Map,this._publicKeys=new Map;const[t]=arguments;if(t!=null){if(typeof t[Symbol.iterator]!="function")throw new TypeError(typeof t+" is not iterable (cannot read property Symbol(Symbol.iterator))");for(const[s,r]of t)this.set(s,r)}}_getPublicKeys(t,s=!1){if(!Array.isArray(t))throw new TypeError("The keys parameter must be an array");const r=this._getPrivateKey(t,s);let n;return r&&this._publicKeys.has(r)?n=this._publicKeys.get(r):s&&(n=[...t],this._publicKeys.set(r,n)),{privateKey:r,publicKey:n}}_getPrivateKey(t,s=!1){const r=[];for(let n of t){n===null&&(n=Ze);const o=typeof n=="object"||typeof n=="function"?"_objectHashes":typeof n=="symbol"?"_symbolHashes":!1;if(!o)r.push(n);else if(this[o].has(n))r.push(this[o].get(n));else if(s){const a=`@@mkm-ref-${Ye++}@@`;this[o].set(n,a),r.push(a)}else return!1}return JSON.stringify(r)}set(t,s){const{publicKey:r}=this._getPublicKeys(t,!0);return super.set(r,s)}get(t){const{publicKey:s}=this._getPublicKeys(t);return super.get(s)}has(t){const{publicKey:s}=this._getPublicKeys(t);return super.has(s)}delete(t){const{publicKey:s,privateKey:r}=this._getPublicKeys(t);return!!(s&&super.delete(s)&&this._publicKeys.delete(r))}clear(){super.clear(),this._symbolHashes.clear(),this._publicKeys.clear()}get[Symbol.toStringTag](){return"ManyKeysMap"}get size(){return super.size}}new Je;function it(){}function D(e,...t){}const Qe={debug:(...e)=>D(console.debug,...e),log:(...e)=>D(console.log,...e),warn:(...e)=>D(console.warn,...e),error:(...e)=>D(console.error,...e)};return(async()=>{try{const{main:e,...t}=He,s=new H("content",t);return await e(s)}catch(e){throw Qe.error('The content script "content" crashed on startup!',e),e}})()})();
content;
