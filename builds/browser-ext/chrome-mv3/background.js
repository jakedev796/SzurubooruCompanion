var background=(function(){"use strict";function Y(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var T={exports:{}},G=T.exports,O;function H(){return O||(O=1,(function(e,r){(function(t,o){o(e)})(typeof globalThis<"u"?globalThis:typeof self<"u"?self:G,function(t){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)t.exports=globalThis.browser;else{const o="The message port closed before a response was received.",i=c=>{const w={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(Object.keys(w).length===0)throw new Error("api-metadata.json has not been included in browser-polyfill");class k extends WeakMap{constructor(n,g=void 0){super(g),this.createItem=n}get(n){return this.has(n)||this.set(n,this.createItem(n)),super.get(n)}}const se=s=>s&&typeof s=="object"&&typeof s.then=="function",D=(s,n)=>(...g)=>{c.runtime.lastError?s.reject(new Error(c.runtime.lastError.message)):n.singleCallbackArg||g.length<=1&&n.singleCallbackArg!==!1?s.resolve(g[0]):s.resolve(g)},v=s=>s==1?"argument":"arguments",ne=(s,n)=>function(m,...u){if(u.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${v(n.minArgs)} for ${s}(), got ${u.length}`);if(u.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${v(n.maxArgs)} for ${s}(), got ${u.length}`);return new Promise((x,f)=>{if(n.fallbackToNoCallback)try{m[s](...u,D({resolve:x,reject:f},n))}catch(a){console.warn(`${s} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,a),m[s](...u),n.fallbackToNoCallback=!1,n.noCallback=!0,x()}else n.noCallback?(m[s](...u),x()):m[s](...u,D({resolve:x,reject:f},n))})},J=(s,n,g)=>new Proxy(n,{apply(m,u,x){return g.call(u,s,...x)}});let P=Function.call.bind(Object.prototype.hasOwnProperty);const $=(s,n={},g={})=>{let m=Object.create(null),u={has(f,a){return a in s||a in m},get(f,a,d){if(a in m)return m[a];if(!(a in s))return;let A=s[a];if(typeof A=="function")if(typeof n[a]=="function")A=J(s,s[a],n[a]);else if(P(g,a)){let p=ne(a,g[a]);A=J(s,s[a],p)}else A=A.bind(s);else if(typeof A=="object"&&A!==null&&(P(n,a)||P(g,a)))A=$(A,n[a],g[a]);else if(P(g,"*"))A=$(A,n[a],g["*"]);else return Object.defineProperty(m,a,{configurable:!0,enumerable:!0,get(){return s[a]},set(p){s[a]=p}}),A;return m[a]=A,A},set(f,a,d,A){return a in m?m[a]=d:s[a]=d,!0},defineProperty(f,a,d){return Reflect.defineProperty(m,a,d)},deleteProperty(f,a){return Reflect.deleteProperty(m,a)}},x=Object.create(s);return new Proxy(x,u)},j=s=>({addListener(n,g,...m){n.addListener(s.get(g),...m)},hasListener(n,g){return n.hasListener(s.get(g))},removeListener(n,g){n.removeListener(s.get(g))}}),te=new k(s=>typeof s!="function"?s:function(g){const m=$(g,{},{getContent:{minArgs:0,maxArgs:0}});s(m)}),q=new k(s=>typeof s!="function"?s:function(g,m,u){let x=!1,f,a=new Promise(C=>{f=function(h){x=!0,C(h)}}),d;try{d=s(g,m,f)}catch(C){d=Promise.reject(C)}const A=d!==!0&&se(d);if(d!==!0&&!A&&!x)return!1;const p=C=>{C.then(h=>{u(h)},h=>{let R;h&&(h instanceof Error||typeof h.message=="string")?R=h.message:R="An unexpected error occurred",u({__mozWebExtensionPolyfillReject__:!0,message:R})}).catch(h=>{console.error("Failed to send onMessage rejected reply",h)})};return p(A?d:a),!0}),oe=({reject:s,resolve:n},g)=>{c.runtime.lastError?c.runtime.lastError.message===o?n():s(new Error(c.runtime.lastError.message)):g&&g.__mozWebExtensionPolyfillReject__?s(new Error(g.message)):n(g)},W=(s,n,g,...m)=>{if(m.length<n.minArgs)throw new Error(`Expected at least ${n.minArgs} ${v(n.minArgs)} for ${s}(), got ${m.length}`);if(m.length>n.maxArgs)throw new Error(`Expected at most ${n.maxArgs} ${v(n.maxArgs)} for ${s}(), got ${m.length}`);return new Promise((u,x)=>{const f=oe.bind(null,{resolve:u,reject:x});m.push(f),g.sendMessage(...m)})},ie={devtools:{network:{onRequestFinished:j(te)}},runtime:{onMessage:j(q),onMessageExternal:j(q),sendMessage:W.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:W.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},L={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return w.privacy={network:{"*":L},services:{"*":L},websites:{"*":L}},$(c,ie,w)};t.exports=i(chrome)}})})(T)),T.exports}var I=H();const l=Y(I);function Z(e){return e==null||typeof e=="function"?{main:e}:e}const N="ccc_config",y="ccc_auth";async function M(){return(await l.storage.local.get(N))[N]??{baseUrl:"http://localhost:21425"}}async function z(){const r=(await l.storage.local.get(y))[y];if(!r)return null;const t=await M(),o=await fetch(`${t.baseUrl}/api/auth/refresh`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({refresh_token:r.refreshToken})});if(!o.ok)return null;const c={accessToken:(await o.json()).access_token,refreshToken:r.refreshToken};return await l.storage.local.set({[y]:c}),c}async function S(){const e={"Content-Type":"application/json",Accept:"application/json"},t=(await l.storage.local.get(y))[y];return t&&(e.Authorization=`Bearer ${t.accessToken}`),e}async function B(e,r){var w;const t=await M();let o=await S();const i={url:e};r!=null&&r.source&&(i.source=r.source),(w=r==null?void 0:r.tags)!=null&&w.length&&(i.tags=r.tags),r!=null&&r.safety&&(i.safety=r.safety),r!=null&&r.skipTagging&&(i.skip_tagging=r.skipTagging);let c=await fetch(`${t.baseUrl}/api/jobs`,{method:"POST",headers:o,body:JSON.stringify(i)});if(c.status===401)if(await z())o=await S(),c=await fetch(`${t.baseUrl}/api/jobs`,{method:"POST",headers:o,body:JSON.stringify(i)});else throw new Error("Authentication expired. Please log in again.");if(!c.ok){const k=await c.text();throw new Error(`CCC returned ${c.status}: ${k}`)}return c.json()}async function K(e){const r=await M();let t=await S(),o=await fetch(`${r.baseUrl}/api/jobs/${e}`,{headers:t});if(o.status===401)if(await z())t=await S(),o=await fetch(`${r.baseUrl}/api/jobs/${e}`,{headers:t});else throw new Error("Authentication expired. Please log in again.");if(!o.ok){const i=await o.text();throw new Error(`CCC returned ${o.status}: ${i}`)}return o.json()}const V=3e3,F=600*1e3;function Q(e,r){const t="ccc-toast-"+Date.now(),o=document.createElement("div");o.id=t,o.textContent=e,o.style.cssText=["position:fixed","bottom:24px","right:24px","max-width:320px","padding:12px 16px","border-radius:8px","font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif","font-size:14px","font-weight:500","box-shadow:0 4px 12px rgba(0,0,0,0.25)","z-index:2147483647","pointer-events:none",r==="success"?"background:#22c55e":"background:#ef4444","color:#fff"].join(";");const i=document.createElement("style");i.textContent="@keyframes ccc-toast-in{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}",document.head.appendChild(i),document.body.appendChild(o),o.style.animation="ccc-toast-in 0.2s ease",setTimeout(()=>{o.style.opacity="0",o.style.transition="opacity 0.2s ease",setTimeout(()=>{o.remove(),i.remove()},200)},4e3)}async function b(e,r,t,o){if(l.notifications&&l.notifications.create({type:"basic",iconUrl:l.runtime.getURL("icon/128.png"),title:r,message:e.slice(0,200)}),l.scripting&&o)try{await l.scripting.executeScript({target:{tabId:o},func:Q,args:[e,t]})}catch{}}async function _(e,r,t){var o;try{const i=await K(e);if(i.status==="completed"){const c=i.szuru_post_id?`Uploaded to Szurubooru (post #${i.szuru_post_id})`:"Upload complete.";await b(c,"Szurubooru Companion","success",r);return}if(i.status==="failed"){const c=((o=i.error_message)==null?void 0:o.slice(0,200))||"Upload failed.";await b(c,"Szurubooru Companion – Failed","error",r);return}if(i.status==="paused"||i.status==="stopped"){await b(`Job was ${i.status}.`,"Szurubooru Companion","error",r);return}}catch(i){if(console.error("[CCC] Poll error:",i),Date.now()-t>F){await b("Job status check timed out.","Szurubooru Companion","error",r);return}}if(Date.now()-t>F){await b("Job is still processing. Check the SzuruCompanion Dashboard.","Szurubooru Companion","error",r);return}setTimeout(()=>_(e,r,t),V)}async function X(e,r){try{const t=await B(e.url,{source:e.source,tags:e.tags,safety:e.safety});return console.log("[CCC] Job created from content script:",t.id,e),l.notifications&&l.notifications.create({type:"basic",iconUrl:l.runtime.getURL("icon/128.png"),title:"Szurubooru Companion",message:"Queued. You'll be notified when it finishes."}),_(t.id,r,Date.now()),{success:!0,jobId:t.id}}catch(t){const o=t instanceof Error?t.message:String(t);return console.error("[CCC] Failed to submit job from content script:",t),await b(o.slice(0,200),"Szurubooru Companion – Error","error",r),{success:!1,error:o}}}const ee=Z(()=>{l.runtime.onInstalled.addListener(()=>{l.contextMenus.create({id:"ccc-send-image",title:"Send to Szurubooru",contexts:["image","video"]}),l.contextMenus.create({id:"ccc-send-link",title:"Send link to Szurubooru",contexts:["link"]}),l.contextMenus.create({id:"ccc-send-page",title:"Send page URL to Szurubooru",contexts:["page"]})}),l.contextMenus.onClicked.addListener(async(e,r)=>{let t;switch(e.menuItemId){case"ccc-send-image":t=(r==null?void 0:r.url)??e.srcUrl;break;case"ccc-send-link":t=e.linkUrl;break;case"ccc-send-page":t=e.pageUrl??(r==null?void 0:r.url);break}if(!t)return;const o=r==null?void 0:r.id;try{const i=await B(t);console.log("[CCC] Job created:",i.id),l.notifications&&l.notifications.create({type:"basic",iconUrl:l.runtime.getURL("icon/128.png"),title:"Szurubooru Companion",message:"Queued. You'll be notified when it finishes."}),_(i.id,o,Date.now())}catch(i){const c=i instanceof Error?i.message:String(i);console.error("[CCC] Failed to submit job:",i),await b(c.slice(0,200),"Szurubooru Companion – Error","error",o)}}),l.runtime.onMessage.addListener((e,r,t)=>{var o;return e.action==="SUBMIT_JOB"?(X(e.payload,(o=r.tab)==null?void 0:o.id).then(t).catch(i=>{t({success:!1,error:i.message})}),!0):!1})});function ge(){}function E(e,...r){}const re={debug:(...e)=>E(console.debug,...e),log:(...e)=>E(console.log,...e),warn:(...e)=>E(console.warn,...e),error:(...e)=>E(console.error,...e)};let U;try{U=ee.main(),U instanceof Promise&&console.warn("The background's main() function return a promise, but it must be synchronous")}catch(e){throw re.error("The background crashed on startup!"),e}return U})();
background;
